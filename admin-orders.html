// admin-script.js
class AdminSystem {
    constructor() {
        this.config = window.AdminConfig;
        this.currentUser = null;
        this.init();
    }
    
    init() {
        this.checkLogin();
        this.loadDashboard();
        this.setupEventListeners();
        this.startAutoSave();
        this.startRealTimeUpdates();
    }
    
    checkLogin() {
        const token = localStorage.getItem('admin_token');
        if (!token) {
            window.location.href = 'admin-login.html';
            return;
        }
        
        try {
            this.currentUser = JSON.parse(localStorage.getItem('admin_user'));
            this.updateUI();
        } catch (error) {
            this.logout();
        }
    }
    
    updateUI() {
        if (this.currentUser) {
            document.getElementById('adminName').textContent = this.currentUser.fullName;
            document.getElementById('lastUpdate').textContent = new Date().toLocaleString('ar-MA');
        }
    }
    
    loadDashboard() {
        this.loadStats();
        this.loadRecentOrders();
        this.loadRecentActivity();
        this.initCharts();
    }
    
    loadStats() {
        // تحميل الإحصائيات من localStorage أو API
        const stats = JSON.parse(localStorage.getItem('site_stats')) || {
            totalOrders: 42,
            totalVisitors: 156,
            totalMessages: 8,
            totalRevenue: 12500
        };
        
        document.getElementById('totalOrders').textContent = stats.totalOrders;
        document.getElementById('totalVisitors').textContent = stats.totalVisitors;
        document.getElementById('totalMessages').textContent = stats.totalMessages;
        document.getElementById('totalRevenue').textContent = this.formatCurrency(stats.totalRevenue);
    }
    
    loadRecentOrders() {
        const orders = JSON.parse(localStorage.getItem('orders')) || this.getSampleOrders();
        const tbody = document.getElementById('recentOrders');
        tbody.innerHTML = '';
        
        orders.slice(0, 5).forEach(order => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>#${order.id}</td>
                <td>${order.customer}</td>
                <td>${order.service}</td>
                <td><span class="status-badge status-${order.status}">${this.getStatusText(order.status)}</span></td>
                <td>${new Date(order.date).toLocaleDateString('ar-MA')}</td>
                <td>
                    <button class="btn-view" onclick="viewOrder(${order.id})">عرض</button>
                </td>
            `;
            tbody.appendChild(row);
        });
    }
    
    loadRecentActivity() {
        const activities = JSON.parse(localStorage.getItem('activities')) || this.getSampleActivities();
        const container = document.getElementById('activityList');
        container.innerHTML = '';
        
        activities.slice(0, 5).forEach(activity => {
            const item = document.createElement('div');
            item.className = 'activity-item';
            item.innerHTML = `
                <div class="activity-icon">
                    <i class="fas ${activity.icon}"></i>
                </div>
                <div class="activity-content">
                    <h4>${activity.title}</h4>
                    <p>${activity.description}</p>
                    <span class="activity-time">${this.formatTime(activity.time)}</span>
                </div>
            `;
            container.appendChild(item);
        });
    }
    
    initCharts() {
        const ctx = document.getElementById('visitorsChart').getContext('2d');
        this.visitorsChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: ['الأحد', 'الإثنين', 'الثلاثاء', 'الأربعاء', 'الخميس', 'الجمعة', 'السبت'],
                datasets: [{
                    label: 'عدد الزوار',
                    data: [65, 59, 80, 81, 56, 55, 40],
                    borderColor: '#2563eb',
                    backgroundColor: 'rgba(37, 99, 235, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        rtl: true,
                        labels: {
                            font: {
                                family: 'Tajawal'
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        ticks: {
                            font: {
                                family: 'Tajawal'
                            }
                        }
                    },
                    y: {
                        ticks: {
                            font: {
                                family: 'Tajawal'
                            }
                        }
                    }
                }
            }
        });
    }
    
    getSampleOrders() {
        return [
            { id: 1001, customer: 'أحمد محمد', service: 'متجر Shopify', status: 'pending', date: '2024-01-15' },
            { id: 1002, customer: 'سارة علي', service: 'موقع شخصي', status: 'completed', date: '2024-01-14' },
            { id: 1003, customer: 'محمد حسن', service: 'متجر YouCan', status: 'processing', date: '2024-01-14' },
            { id: 1004, customer: 'فاطمة عمر', service: 'هوية رقمية', status: 'completed', date: '2024-01-13' },
            { id: 1005, customer: 'علي إبراهيم', service: 'موقع تجاري', status: 'pending', date: '2024-01-12' }
        ];
    }
    
    getSampleActivities() {
        return [
            {
                icon: 'fa-shopping-cart',
                title: 'طلب جديد',
                description: 'تم استلام طلب جديد من أحمد محمد',
                time: new Date(Date.now() - 3600000) // منذ ساعة
            },
            {
                icon: 'fa-check-circle',
                title: 'اكتمال مشروع',
                description: 'تم الانتهاء من مشروع متجر سارة',
                time: new Date(Date.now() - 7200000) // منذ ساعتين
            },
            {
                icon: 'fa-user-plus',
                title: 'عميل جديد',
                description: 'عميل جديد قام بالتسجيل في الموقع',
                time: new Date(Date.now() - 86400000) // منذ يوم
            },
            {
                icon: 'fa-comment',
                title: 'رسالة جديدة',
                description: 'رسالة استفسار من محمد حسن',
                time: new Date(Date.now() - 172800000) // منذ يومين
            },
            {
                icon: 'fa-money-bill-wave',
                title: 'دفعة مستلمة',
                description: 'تم استلام دفعة من فاطمة عمر',
                time: new Date(Date.now() - 259200000) // منذ ثلاثة أيام
            }
        ];
    }
    
    getStatusText(status) {
        const statusMap = {
            'pending': 'قيد الانتظار',
            'processing': 'قيد التنفيذ',
            'completed': 'مكتمل',
            'cancelled': 'ملغي'
        };
        return statusMap[status] || status;
    }
    
    formatCurrency(amount) {
        return new Intl.NumberFormat('ar-MA', {
            style: 'currency',
            currency: 'MAD'
        }).format(amount);
    }
    
    formatTime(date) {
        const now = new Date();
        const diff = now - new Date(date);
        const minutes = Math.floor(diff / 60000);
        const hours = Math.floor(minutes / 60);
        const days = Math.floor(hours / 24);
        
        if (minutes < 60) {
            return `قبل ${minutes} دقيقة`;
        } else if (hours < 24) {
            return `قبل ${hours} ساعة`;
        } else {
            return `قبل ${days} يوم`;
        }
    }
    
    startAutoSave() {
        setInterval(() => {
            this.saveData();
        }, 30000); // حفظ تلقائي كل 30 ثانية
    }
    
    startRealTimeUpdates() {
        setInterval(() => {
            this.updateRealTimeData();
        }, 10000); // تحديث بيانات الوقت الحقيقي كل 10 ثواني
    }
    
    saveData() {
        // حفظ البيانات في localStorage
        const data = {
            lastSave: new Date().toISOString(),
            stats: {
                totalOrders: parseInt(document.getElementById('totalOrders').textContent),
                totalVisitors: parseInt(document.getElementById('totalVisitors').textContent),
                totalMessages: parseInt(document.getElementById('totalMessages').textContent),
                totalRevenue: parseInt(document.getElementById('totalRevenue').textContent.replace(/[^0-9]/g, ''))
            }
        };
        
        localStorage.setItem('site_stats', JSON.stringify(data.stats));
        console.log('تم الحفظ التلقائي:', data.lastSave);
    }
    
    updateRealTimeData() {
        // محاكاة تحديث بيانات الوقت الحقيقي
        const visitors = document.getElementById('totalVisitors');
        const current = parseInt(visitors.textContent);
        const change = Math.floor(Math.random() * 3); // 0-2 زوار جدد
        visitors.textContent = current + change;
    }
    
    setupEventListeners() {
        // تصفية الإحصائيات حسب الفترة
        document.getElementById('statsPeriod').addEventListener('change', (e) => {
            this.updateChartByPeriod(e.target.value);
        });
        
        // تحديث البيانات يدويًا
        document.querySelector('.refresh-btn')?.addEventListener('click', () => {
            this.loadDashboard();
            this.showNotification('تم تحديث البيانات بنجاح', 'success');
        });
    }
    
    updateChartByPeriod(period) {
        // تحديث الرسم البياني حسب الفترة المحددة
        let data;
        switch (period) {
            case 'today':
                data = [65, 59, 80, 81, 56, 55, 40];
                break;
            case 'week':
                data = [120, 150, 180, 200, 170, 160, 140];
                break;
            case 'month':
                data = [650, 700, 800, 750, 850, 900, 950];
                break;
            case 'year':
                data = [1000, 1200, 1500, 1800, 2000, 2200, 2400];
                break;
        }
        
        this.visitorsChart.data.datasets[0].data = data;
        this.visitorsChart.update();
    }
    
    showNotification(message, type = 'info') {
        // إنشاء إشعار
        const notification = document.createElement('div');
        notification.className = `notification notification-${type}`;
        notification.innerHTML = `
            <i class="fas fa-${this.getNotificationIcon(type)}"></i>
            <span>${message}</span>
            <button onclick="this.parentElement.remove()">&times;</button>
        `;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 5000);
    }
    
    getNotificationIcon(type) {
        const icons = {
            'success': 'check-circle',
            'error': 'exclamation-circle',
            'warning': 'exclamation-triangle',
            'info': 'info-circle'
        };
        return icons[type] || 'info-circle';
    }
    
    logout() {
        localStorage.removeItem('admin_token');
        localStorage.removeItem('admin_user');
        window.location.href = 'admin-login.html';
    }
}

// وظائف عامة
function toggleSidebar() {
    document.getElementById('sidebar').classList.toggle('active');
}

function logout() {
    if (confirm('هل أنت متأكد من تسجيل الخروج؟')) {
        adminSystem.logout();
    }
}

function viewOrder(orderId) {
    // عرض تفاصيل الطلب
    alert(`عرض تفاصيل الطلب #${orderId}`);
    // في الإصدار الكامل: فتح مودال أو صفحة جديدة
}

// تهيئة النظام عند تحميل الصفحة
let adminSystem;
document.addEventListener('DOMContentLoaded', () => {
    adminSystem = new AdminSystem();
});
